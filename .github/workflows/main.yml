name: "‚ö° Karpux Labs | Lite DevBox (Selector: Tailscale / Ngrok)"

on:
  workflow_dispatch:
    inputs:
      method:
        description: "M√©todo de conexi√≥n"
        type: choice
        required: true
        default: tailscale
        options:
          - tailscale
          - ngrok
          - both
      hostname:
        description: "Hostname (para Tailscale / Tunnel)"
        required: true
        default: "karpux-lite-box"

jobs:
  deploy-lite:
    name: "üì± DevBox Lite"
    runs-on: windows-latest
    timeout-minutes: 3600

    defaults:
      run:
        shell: pwsh

    env:
      TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      HOSTNAME: ${{ inputs.hostname }}

    steps:
      # 1) User + RDP ON (password fija) + Desactivar NLA para compatibilidad Ngrok
      - name: üõ°Ô∏è Configurar Sistema (User + RDP)
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "::add-mask::$env:TS_AUTHKEY"
          if ($env:NGROK_AUTHTOKEN) { Write-Host "::add-mask::$env:NGROK_AUTHTOKEN" }

          Write-Host "üîê Estableciendo contrase√±a est√°tica..."
          $user = "runneradmin"
          $pass = "KarpuxDev@33" | ConvertTo-SecureString -AsPlainText -Force
          Set-LocalUser -Name $user -Password $pass

          Write-Host "üß© Habilitando RDP..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          
          # IMPORTANTE: Desactivar NLA (UserAuthentication = 0) ayuda a que Ngrok conecte sin errores de protocolo
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          
          Start-Service TermService -ErrorAction SilentlyContinue

      # 2A) Tailscale (si method=tailscale o both)
      - name: üì° Conectar Tailscale VPN
        if: ${{ inputs.method == 'tailscale' || inputs.method == 'both' }}
        run: |
          $ErrorActionPreference = "Stop"

          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath "ts.exe" -ArgumentList "/quiet", "/norestart" -Wait

          $ts = "C:\Program Files\Tailscale\tailscale.exe"
          & $ts up --authkey=$env:TS_AUTHKEY --hostname=$env:HOSTNAME --unattended --reset

          $ip = & $ts ip -4
          "TAILSCALE_IP=$ip" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "‚úÖ Tailscale OK: $ip"

      # 2B-1) Firewall ESTRICTO (SOLO si method=tailscale)
      # Bloquea todo excepto la red de Tailscale. NO se ejecuta en 'both'.
      - name: üî• Firewall RDP (Modo Estricto Tailscale)
        if: ${{ inputs.method == 'tailscale' }}
        run: |
          $ErrorActionPreference = "Stop"
          Disable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          New-NetFirewallRule `
            -DisplayName "RDP over Tailscale" `
            -Direction Inbound -Action Allow -Protocol TCP -LocalPort 3389 `
            -RemoteAddress "100.64.0.0/10" -Profile Any | Out-Null
          Write-Host "üîí RDP blindado: Solo accesible v√≠a Tailscale VPN."

      # 2B-2) Firewall ABIERTO (Si method=ngrok o both)
      # Abre el puerto 3389 para permitir el t√∫nel de Ngrok.
      - name: üîì Firewall RDP (Modo Abierto para Ngrok)
        if: ${{ inputs.method == 'ngrok' || inputs.method == 'both' }}
        run: |
          $ErrorActionPreference = "Stop"
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          # Crear regla expl√≠cita por seguridad
          New-NetFirewallRule `
            -DisplayName "Allow RDP for Tunnel" `
            -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow -Profile Any | Out-Null
          Write-Host "üîì RDP abierto para permitir t√∫nel Ngrok."

      # 2C) Ngrok (si method=ngrok o both) -> crea tunnel TCP a 3389
      - name: üåç Conectar Ngrok (TCP 3389)
        if: ${{ inputs.method == 'ngrok' || inputs.method == 'both' }}
        run: |
          $ErrorActionPreference = "Stop"

          if (-not $env:NGROK_AUTHTOKEN) {
            throw "Falta secrets.NGROK_AUTHTOKEN"
          }

          choco install ngrok -y --no-progress --limit-output
          Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1" -ErrorAction SilentlyContinue
          refreshenv

          $ngrok = (Get-Command ngrok -ErrorAction SilentlyContinue)?.Source
          if (-not $ngrok) { $ngrok = "C:\ProgramData\chocolatey\bin\ngrok.exe" }
          if (-not (Test-Path $ngrok)) { throw "No encuentro ngrok.exe" }

          & $ngrok config add-authtoken $env:NGROK_AUTHTOKEN

          Start-Process -FilePath $ngrok -ArgumentList @("tcp","3389","--log","stdout") -NoNewWindow | Out-Null

          $url = $null
          for ($i=0; $i -lt 40; $i++) {
            try {
              $t = Invoke-RestMethod "http://127.0.0.1:4040/api/tunnels"
              if ($t.tunnels.Count -gt 0) { $url = $t.tunnels[0].public_url; break }
            } catch {}
            Start-Sleep -Seconds 1
          }

          if (-not $url) { throw "No pude obtener la URL p√∫blica de ngrok." }

          "NGROK_RDP_URL=$url" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "‚úÖ Ngrok OK: $url"

      # 3) Mostrar instrucciones (seg√∫n m√©todo)
      - name: ‚úÖ Info de conexi√≥n
        run: |
          Write-Host "============================================="
          Write-Host "‚ö° KARPUX LABS | DEVBOX LISTO"
          Write-Host "M√©todo: ${{ inputs.method }}"
          if ("${{ inputs.method }}" -eq "tailscale" -or "${{ inputs.method }}" -eq "both") {
            Write-Host "RDP (Tailscale): $env:TAILSCALE_IP  | user: runneradmin | pass: KarpuxDev@33"
          }
          if ("${{ inputs.method }}" -eq "ngrok" -or "${{ inputs.method }}" -eq "both") {
            Write-Host "RDP (Ngrok): $env:NGROK_RDP_URL  | user: runneradmin | pass: KarpuxDev@33"
          }
          Write-Host "============================================="

      # 4) Mantener vivo el runner
      - name: üïí Mantener runner vivo
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "üü¢ Runner vivo. Cancela el workflow cuando termines."
          while ($true) {
            Write-Host ("üïí Heartbeat: " + (Get-Date).ToString("yyyy-MM-dd HH:mm:ss"))
            Start-Sleep -Seconds 300
          }
