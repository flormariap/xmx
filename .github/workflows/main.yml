name: "‚ö° Karpux Labs | Lite DevBox (+Firewall)"

on:
  workflow_dispatch:

jobs:
  deploy-lite-firewall:
    name: "üì± DevBox Lite"
    runs-on: windows-latest
    timeout-minutes: 360

    defaults:
      run:
        shell: pwsh

    env:
      TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      HOSTNAME: "karpux-lite-box"

    steps:
      # 1. Configuraci√≥n de Usuario y Firewall (Combinados)
      - name: üõ°Ô∏è Configurar Sistema (User + Firewall)
        run: |
          Write-Host "üîê Estableciendo contrase√±a est√°tica..."
          $user = "runneradmin"
          $pass = "KarpuxDev@33" | ConvertTo-SecureString -AsPlainText -Force
          Set-LocalUser -Name $user -Password $pass

          Write-Host "üî• Abriendo puertos del Firewall..."
          try {
              # Habilitar RDP en el registro
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0 -ErrorAction Stop
              # Permitir tr√°fico RDP
              Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction Stop
              Write-Host "‚úÖ Firewall configurado correctamente."
          } catch {
              Write-Host "‚ö†Ô∏è Error configurando Firewall: $_"
          }

      # 2. Instalar VS Code
      - name: üì¶ Instalar VS Code
        run: |
          Write-Host "‚¨áÔ∏è Instalando Editor..."
          choco install vscode -y --no-progress --limit-output

      # 3. Conectar VPN
      - name: üì° Conectar Tailscale VPN
        run: |
          Write-Host "‚òÅÔ∏è Iniciando Tailscale..."
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath "ts.exe" -ArgumentList "/quiet", "/norestart" -Wait
          & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey=$env:TS_AUTHKEY --hostname=$env:HOSTNAME --unattended
          Write-Host "‚úÖ VPN Conectada: Puedes hacer RDP a la IP de Tailscale."

      # 4. Loop Principal (VS Code Tunnel)
      - name: üíª INICIAR VS CODE TUNNEL
        run: |
          # Refrescar PATH
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          Write-Host "============================================="
          Write-Host "   ‚ö° KARPUX LABS | LITE + RDP READY ‚ö°      "
          Write-Host "============================================="
          Write-Host "1. RDP: Usa la IP de Tailscale con usuario 'runneradmin' y pass 'KarpuxDev@33'"
          Write-Host "2. WEB: Autoriza el t√∫nel abajo para usar VS Code en el navegador."
          Write-Host "============================================="
          
          code tunnel --accept-server-license-terms --name $env:HOSTNAME
