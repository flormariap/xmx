name: "‚ö° Karpux DevBox | Ngrok Only Edition"

on:
  workflow_dispatch:

jobs:
  deploy-ngrok:
    name: "üöÄ Desplegar PC Ngrok"
    runs-on: windows-latest
    timeout-minutes: 360
    
    defaults:
      run:
        shell: pwsh

    steps:
      # 1. Configuraci√≥n de Usuario y RDP (Sin seguridad NLA para que conecte f√°cil)
      - name: üë§ Crear Usuario y Configurar RDP
        run: |
          $ErrorActionPreference = "Stop"
          
          Write-Host "1Ô∏è‚É£ Creando usuario 'runneradmin'..."
          $pass = "KarpuxDev@33" | ConvertTo-SecureString -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $pass

          Write-Host "2Ô∏è‚É£ Configurando Regedit para RDP..."
          # Habilitar RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          # DESACTIVAR NLA (Esto arregla el error de conexi√≥n 0x104 en muchos casos)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          
          Write-Host "3Ô∏è‚É£ Iniciando servicio..."
          Start-Service TermService -ErrorAction SilentlyContinue

      # 2. APAGAR FIREWALL (Modo Nuclear)
      - name: üî• Apagar Firewall (Para que entre Ngrok)
        run: |
          Write-Host "‚ò¢Ô∏è Apagando Firewall de Windows..."
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          Write-Host "‚úÖ Firewall Muerto. Paso libre para Ngrok."

      # 3. Instalar y Correr Ngrok
      - name: üåç Lanzar T√∫nel Ngrok
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          if (-not $env:NGROK_TOKEN) { throw "‚ö†Ô∏è FALTA EL SECRET: NGROK_AUTHTOKEN" }

          Write-Host "‚¨áÔ∏è Instalando Ngrok..."
          choco install ngrok -y --no-progress --limit-output
          
          $ngrok = "C:\ProgramData\chocolatey\bin\ngrok.exe"
          
          # Autenticar
          & $ngrok config add-authtoken $env:NGROK_TOKEN
          
          # Iniciar T√∫nel en puerto 3389 (Region US para mejor ping en Latam)
          Write-Host "üöÄ Iniciando t√∫nel..."
          Start-Process -FilePath $ngrok -ArgumentList @("tcp","3389","--region","us") -NoNewWindow
          
          # Esperar a que Ngrok genere el link
          Write-Host "‚è≥ Esperando URL p√∫blica..."
          Start-Sleep -Seconds 5
          
          $url = $null
          for ($i=0; $i -lt 20; $i++) {
            try {
              $t = Invoke-RestMethod "http://127.0.0.1:4040/api/tunnels"
              if ($t.tunnels.Count -gt 0) { 
                $url = $t.tunnels[0].public_url
                break 
              }
            } catch {}
            Start-Sleep -Seconds 2
          }

          if (-not $url) { throw "‚ùå Ngrok no arranc√≥. Revisa tu token." }

          # LIMPIAR URL (Quitar tcp://)
          $cleanUrl = $url.Replace("tcp://", "")
          
          # Guardar en variables de entorno
          "FINAL_URL=$cleanUrl" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "‚úÖ T√öNEL OBTENIDO: $cleanUrl"

      # 4. MOSTRAR DATOS LIMPIOS
      - name: üì± DATOS PARA TU CELULAR
        run: |
          Write-Host " "
          Write-Host "============================================="
          Write-Host "   ‚ö° KARPUX LABS | CONEXI√ìN LISTA ‚ö°"
          Write-Host "============================================="
          Write-Host "üìç PC NAME (Host):   $env:FINAL_URL"
          Write-Host "üë§ USER ACCOUNT:     runneradmin"
          Write-Host "üîë PASSWORD:         KarpuxDev@33"
          Write-Host "============================================="
          Write-Host " "
          Write-Host "‚ö†Ô∏è COPIA EL 'PC NAME' TAL CUAL, SIN tcp://"

      # 5. Mantener vivo
      - name: üïí Mantener Encendido
        run: |
          Write-Host "üü¢ Sistema corriendo. No cierres esta pesta√±a."
          while ($true) { Start-Sleep -Seconds 300 }
