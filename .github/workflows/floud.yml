name: "‚ö° Karpux Labs | DevBox SelfHost"

on:
  workflow_dispatch:

jobs:
  devbox:
    name: "üñ•Ô∏è DevBox Self-Hosted"
    runs-on: self-hosted   # usa tu runner Windows
    timeout-minutes: 4320  # 3 d√≠as, ajusta como quieras

    defaults:
      run:
        shell: pwsh

    env:
      TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      HOSTNAME: "karpux-selfhost-box"

    steps:
      - name: üõ°Ô∏è Configurar Sistema (User + Firewall)
        run: |
          Write-Host "üîê Estableciendo contrase√±a est√°tica..."
          $user = "karpux"
          $pass = "KarpuxDev@33" | ConvertTo-SecureString -AsPlainText -Force
          if (-not (Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $user -Password $pass
          } else {
            Set-LocalUser -Name $user -Password $pass
          }

          Write-Host "üî• Abriendo puertos del Firewall..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: üì¶ Asegurar VS Code
        run: |
          if (-not (Get-Command code -ErrorAction SilentlyContinue)) {
            choco install vscode -y --no-progress --limit-output
          }

      - name: üì° Conectar Tailscale VPN
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath "ts.exe" -ArgumentList "/quiet","/norestart" -Wait
          & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey=$env:TS_AUTHKEY --hostname=$env:HOSTNAME --unattended

      - name: üíª Iniciar VS Code Tunnel
        run: |
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          code tunnel --accept-server-license-terms --name $env:HOSTNAME
