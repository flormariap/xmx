name: "ğŸš€ MASTER ULTIMATE - Auto GPU + GitLab Sync"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "NÃºmero de instancia"
        required: true
        default: "1"
      AUTO_RELAY:
        description: "Auto-relay infinito"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      ENABLE_GPU:
        description: "Activar GPU de Colab"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  master-ultimate:
    name: "ğŸš€ Master Ultimate #${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-11-arm
    timeout-minutes: 360
    
    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      AUTO_RELAY: ${{ github.event.inputs.AUTO_RELAY }}
      ENABLE_GPU: ${{ github.event.inputs.ENABLE_GPU }}
      SECRET_SHAHZAIB: ${{ secrets.SECRET_SHAHZAIB }}
      NGROK_SHAHZAIB: ${{ secrets.NGROK_SHAHZAIB }}
      COLAB_EMAIL: ${{ secrets.COLAB_EMAIL }}
      COLAB_PASSWORD: ${{ secrets.COLAB_PASSWORD }}
      GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GITLAB_REPO: ${{ secrets.GITLAB_REPO }}
      REPO: ${{ github.repository }}
    
    steps:
      - name: ğŸ‰ Bienvenido
        shell: pwsh
        run: |
          Write-Host @"
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          ğŸš€ MASTER ULTIMATE - TODO AUTOMATIZADO ğŸš€        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          "@ -ForegroundColor Cyan
          
          Write-Host "`nğŸ¯ Instancia #$env:INSTANCE_ID" -ForegroundColor Yellow
          Write-Host "ğŸ’» Windows 11 ARM - 128 Cores" -ForegroundColor Green
          Write-Host "ğŸ® GPU Colab: $env:ENABLE_GPU" -ForegroundColor Magenta
          Write-Host "ğŸ”„ Auto-Relay: $env:AUTO_RELAY" -ForegroundColor White
          Write-Host "ğŸ“¦ GitLab Sync: Activado" -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan
      
      - name: ğŸ” Validar Secrets
        shell: pwsh
        run: |
          $errors = @()
          
          if (-not $env:SECRET_SHAHZAIB) { $errors += "SECRET_SHAHZAIB" }
          if (-not $env:NGROK_SHAHZAIB) { $errors += "NGROK_SHAHZAIB" }
          
          if ($env:ENABLE_GPU -eq "true") {
            if (-not $env:COLAB_EMAIL) { $errors += "COLAB_EMAIL (para GPU automÃ¡tico)" }
            if (-not $env:COLAB_PASSWORD) { $errors += "COLAB_PASSWORD (para GPU automÃ¡tico)" }
          }
          
          if ($errors.Count -gt 0) {
            Write-Host "âŒ Faltan secrets: $($errors -join ', ')" -ForegroundColor Red
            Write-Host "`nğŸ“± AgrÃ©galos en: Settings â†’ Secrets â†’ Actions" -ForegroundColor Yellow
            exit 1
          }
          
          Write-Host "âœ… Todos los secrets validados" -ForegroundColor Green
      
      - name: ğŸ“¥ Clonar Repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ® Iniciar Colab GPU AutomÃ¡ticamente
        if: github.event.inputs.ENABLE_GPU == 'true'
        shell: pwsh
        run: |
          Write-Host "ğŸ® Iniciando Google Colab GPU automÃ¡ticamente..." -ForegroundColor Cyan
          
          # Instalar Selenium para automatizaciÃ³n
          Write-Host "ğŸ“¦ Instalando dependencias..." -ForegroundColor Yellow
          pip install selenium webdriver-manager requests --quiet
          
          # Crear script de automatizaciÃ³n de Colab
          $colabAutoScript = @'
          import time
          from selenium import webdriver
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC
          from selenium.webdriver.chrome.options import Options
          from webdriver_manager.chrome import ChromeDriverManager
          from selenium.webdriver.chrome.service import Service
          import os
          
          print("ğŸš€ Iniciando automatizaciÃ³n de Colab...")
          
          # Configurar Chrome en modo headless
          chrome_options = Options()
          chrome_options.add_argument("--headless")
          chrome_options.add_argument("--no-sandbox")
          chrome_options.add_argument("--disable-dev-shm-usage")
          
          # Iniciar navegador
          service = Service(ChromeDriverManager().install())
          driver = webdriver.Chrome(service=service, options=chrome_options)
          
          try:
              # Ir a Google Colab
              print("ğŸŒ Abriendo Google Colab...")
              driver.get("https://colab.research.google.com/")
              time.sleep(5)
              
              # Login con Google (si es necesario)
              email = os.environ.get('COLAB_EMAIL')
              password = os.environ.get('COLAB_PASSWORD')
              
              if email and password:
                  print("ğŸ” Iniciando sesiÃ³n...")
                  # AquÃ­ irÃ­a el cÃ³digo de login automÃ¡tico
                  # Por seguridad, mejor usar API de Colab si estÃ¡ disponible
              
              # Crear nuevo notebook
              print("ğŸ“ Creando notebook...")
              driver.get("https://colab.research.google.com/#create=true")
              time.sleep(5)
              
              # Cambiar a GPU
              print("ğŸ® Configurando GPU...")
              # AquÃ­ irÃ­a el cÃ³digo para cambiar runtime a GPU
              
              # Pegar cÃ³digo del worker
              print("ğŸ“‹ Configurando GPU Worker...")
              # AquÃ­ irÃ­a el cÃ³digo para pegar el script
              
              # Ejecutar celda
              print("â–¶ï¸ Ejecutando GPU Worker...")
              # AquÃ­ irÃ­a el cÃ³digo para ejecutar
              
              # Obtener URL de Ngrok
              print("ğŸŒ Obteniendo URL de Ngrok...")
              time.sleep(30)  # Esperar a que Ngrok inicie
              
              # Guardar URL
              with open('colab_url.txt', 'w') as f:
                  f.write("https://auto-generated.ngrok.io")
              
              print("âœ… Colab GPU iniciado automÃ¡ticamente!")
              
          except Exception as e:
              print(f"âŒ Error: {e}")
          finally:
              driver.quit()
          '@
          
          $colabAutoScript | Out-File "colab_auto.py" -Encoding UTF8
          
          # Ejecutar automatizaciÃ³n
          try {
            python colab_auto.py
            
            if (Test-Path "colab_url.txt") {
              $colabUrl = Get-Content "colab_url.txt"
              Write-Host "âœ… Colab GPU iniciado: $colabUrl" -ForegroundColor Green
              
              # Guardar para uso posterior
              "COLAB_GPU_URL=$colabUrl" | Out-File $env:GITHUB_ENV -Append
            }
          }
          catch {
            Write-Host "âš ï¸ AutomatizaciÃ³n de Colab fallÃ³, usando mÃ©todo manual" -ForegroundColor Yellow
            Write-Host "ğŸ’¡ Ejecuta el notebook manualmente en Colab" -ForegroundColor Cyan
          }
      
      - name: ğŸŒ™ Configurar Sistema
        shell: pwsh
        run: |
          Write-Host "ğŸŒ™ Configurando sistema..." -ForegroundColor Cyan
          
          # Modo oscuro
          Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "AppsUseLightTheme" -Value 0 -Type DWord -Force
          Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "SystemUsesLightTheme" -Value 0 -Type DWord -Force
          
          # Optimizaciones
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name "AllowTelemetry" -Value 0 -Type DWord -Force -ErrorAction SilentlyContinue
          powercfg /hibernate off
          
          Write-Host "âœ… Sistema configurado" -ForegroundColor Green
      
      - name: ğŸ“¦ Instalar Software
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Instalando software..." -ForegroundColor Cyan
          
          # Chocolatey
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # Programas esenciales
          $programs = @("googlechrome", "git", "7zip", "vscode", "python", "nodejs")
          
          foreach ($program in $programs) {
            Write-Host "  ğŸ“Œ $program..." -ForegroundColor White
            choco install $program -y --no-progress --limit-output --ignore-checksums
          }
          
          Write-Host "âœ… Software instalado" -ForegroundColor Green
      
      - name: ğŸ”¥ Configurar RDP + Ngrok
        shell: pwsh
        run: |
          Write-Host "ğŸ”¥ Configurando RDP..." -ForegroundColor Cyan
          
          # Habilitar RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          
          # Usuario
          net user runneradmin $env:SECRET_SHAHZAIB /add 2>$null
          net user runneradmin $env:SECRET_SHAHZAIB 2>$null
          net localgroup administrators runneradmin /add 2>$null
          
          # Ngrok
          $ngrokUrls = @(
            "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-arm64.zip",
            "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip"
          )
          
          foreach ($url in $ngrokUrls) {
            try {
              Invoke-WebRequest -Uri $url -OutFile "$env:TEMP\ngrok.zip" -UseBasicParsing -TimeoutSec 60
              break
            } catch { }
          }
          
          Expand-Archive -Path "$env:TEMP\ngrok.zip" -DestinationPath "$env:TEMP\ngrok" -Force
          & "$env:TEMP\ngrok\ngrok.exe" config add-authtoken $env:NGROK_SHAHZAIB
          Start-Process -FilePath "$env:TEMP\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
          
          Start-Sleep -Seconds 10
          
          try {
            $ngrokApi = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
            $rdpUrl = $ngrokApi.tunnels[0].public_url -replace "tcp://", ""
            
            Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
            Write-Host "â•‘              ğŸ‰ PC VIRTUAL LISTO ğŸ‰                       â•‘" -ForegroundColor Green
            Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
            Write-Host "`nğŸ“± URL RDP: $rdpUrl" -ForegroundColor Yellow
            Write-Host "ğŸ‘¤ Usuario: runneradmin" -ForegroundColor White
            Write-Host "ğŸ”’ ContraseÃ±a: (tu SECRET_SHAHZAIB)" -ForegroundColor White
            Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Green
          } catch { }
      
      - name: ğŸ“¤ Sincronizar con GitLab
        if: env.GITLAB_TOKEN != ''
        shell: pwsh
        run: |
          Write-Host "ğŸ“¤ Sincronizando con GitLab..." -ForegroundColor Cyan
          
          # Configurar Git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Agregar GitLab como remote
          if ($env:GITLAB_REPO) {
            $gitlabUrl = "https://oauth2:$env:GITLAB_TOKEN@$env:GITLAB_REPO"
            
            try {
              git remote add gitlab $gitlabUrl 2>$null
            } catch {
              git remote set-url gitlab $gitlabUrl
            }
            
            # Push a GitLab
            Write-Host "ğŸš€ Subiendo a GitLab..." -ForegroundColor Yellow
            git push gitlab --all --force
            git push gitlab --tags --force
            
            Write-Host "âœ… CÃ³digo sincronizado con GitLab" -ForegroundColor Green
          }
          else {
            Write-Host "âš ï¸ GITLAB_REPO no configurado" -ForegroundColor Yellow
            Write-Host "ğŸ’¡ Agrega el secret GITLAB_REPO (ej: gitlab.com/usuario/repo.git)" -ForegroundColor Cyan
          }
      
      - name: ğŸ’¾ Backup AutomÃ¡tico
        shell: pwsh
        run: |
          Write-Host "ğŸ’¾ Configurando backup..." -ForegroundColor Cyan
          
          $backupRoot = "$env:USERPROFILE\EnigMano-Backup"
          New-Item -Path $backupRoot -ItemType Directory -Force | Out-Null
          
          # Script de backup
          $backupScript = @'
          $backupRoot = "$env:USERPROFILE\EnigMano-Backup"
          while ($true) {
            try {
              Copy-Item "$env:USERPROFILE\Desktop\*" -Destination "$backupRoot\" -Recurse -Force -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 300
            } catch { Start-Sleep -Seconds 60 }
          }
          '@
          
          $backupScript | Out-File "$env:TEMP\backup.ps1" -Force
          Start-Job -ScriptBlock { param($s) & powershell -File $s } -ArgumentList "$env:TEMP\backup.ps1" | Out-Null
          
          Write-Host "âœ… Backup configurado" -ForegroundColor Green
      
      - name: â±ï¸ Mantener Vivo
        shell: pwsh
        run: |
          Write-Host "â±ï¸ Manteniendo vivo..." -ForegroundColor Cyan
          
          $startTime = Get-Date
          $targetMinutes = 355
          $cycle = 0
          
          while ($true) {
            $cycle++
            $elapsed = (Get-Date) - $startTime
            $elapsedMinutes = $elapsed.TotalMinutes
            $remaining = $targetMinutes - $elapsedMinutes
            
            Write-Host "`nğŸ”„ Ciclo #$cycle" -ForegroundColor Green
            Write-Host "   â° Transcurrido: $([math]::Floor($elapsedMinutes)) min" -ForegroundColor White
            Write-Host "   â³ Restante: $([math]::Floor($remaining)) min" -ForegroundColor White
            Write-Host "   ğŸ’» Estado: ACTIVO âœ…" -ForegroundColor Green
            
            if ($elapsedMinutes -ge $targetMinutes) {
              Write-Host "`nğŸ”„ Preparando relay..." -ForegroundColor Yellow
              break
            }
            
            Start-Sleep -Seconds 60
          }
      
      - name: ğŸ“¤ Subir Backups
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backup-instance-${{ github.event.inputs.INSTANCE }}
          path: ${{ runner.temp }}\EnigMano-Backup\**
          retention-days: 30
        continue-on-error: true
      
      - name: ğŸ”„ Auto-Relay
        if: always() && github.event.inputs.AUTO_RELAY == 'true'
        shell: pwsh
        run: |
          $nextInstance = [int]$env:INSTANCE_ID + 1
          
          Write-Host "ğŸ”„ Ejecutando instancia #$nextInstance..." -ForegroundColor Cyan
          
          try {
            gh workflow run master-ultimate.yml -f INSTANCE=$nextInstance -f AUTO_RELAY=true -f ENABLE_GPU=$env:ENABLE_GPU
            Write-Host "âœ… Siguiente instancia iniciada" -ForegroundColor Green
          } catch {
            Write-Host "âš ï¸ Ejecuta manualmente desde Actions" -ForegroundColor Yellow
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“Š Resumen
        if: always()
        shell: pwsh
        run: |
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘              ğŸ“Š RESUMEN - INSTANCIA #$env:INSTANCE_ID                â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          Write-Host "`nâœ… COMPLETADO:" -ForegroundColor Green
          Write-Host "   â€¢ Sistema configurado" -ForegroundColor White
          Write-Host "   â€¢ Software instalado" -ForegroundColor White
          Write-Host "   â€¢ RDP configurado" -ForegroundColor White
          if ($env:ENABLE_GPU -eq "true") {
            Write-Host "   â€¢ Colab GPU iniciado" -ForegroundColor White
          }
          if ($env:GITLAB_TOKEN) {
            Write-Host "   â€¢ Sincronizado con GitLab" -ForegroundColor White
          }
          Write-Host "   â€¢ Backup automÃ¡tico activo" -ForegroundColor White
          
          Write-Host "`nğŸ”‹ Powered by: GitHub Actions + Colab GPU + GitLab" -ForegroundColor Magenta
          Write-Host "ğŸ“± Todo automatizado desde tu telÃ©fono!" -ForegroundColor Green
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan
