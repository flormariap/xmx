name: "ğŸ”¥ EnigMano Ultimate - Win11 + 128 Cores + Google Drive Sync"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance number to deploy (e.g., 1, 2, 3...)"
        required: true
        default: "1"
      MODE:
        description: "Deployment mode"
        required: true
        default: "full"
        type: choice
        options:
          - full          # Todo: Env + Backup + RDP
          - env-only      # Solo configuraciÃ³n del entorno
          - backup-only   # Solo backup a Google Drive
          - custom-iso    # Crear Windows personalizado

jobs:
  deploy-enigmano-ultimate:
    name: "ğŸš€ EnigMano Ultimate Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-11-arm

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      MODE: ${{ github.event.inputs.MODE }}
      SECRET_SHAHZAIB: ${{ secrets.SECRET_SHAHZAIB }}
      NGROK_SHAHZAIB: ${{ secrets.NGROK_SHAHZAIB }}
      GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "enigmano-ultimate.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}

    steps:
      - name: ğŸ“Œ Deployment Parameters
        shell: pwsh
        run: |
          $prevInstance = [int]$env:INSTANCE_ID - 1
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘          EnigMano Ultimate - Deployment Info              â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "ğŸ”¹ Instance Number       : $env:INSTANCE_ID" -ForegroundColor White
          Write-Host "ğŸ”¹ Previous Instance     : $prevInstance" -ForegroundColor White
          Write-Host "ğŸ¯ Deployment Mode       : $env:MODE" -ForegroundColor Yellow
          Write-Host "ğŸ“¦ Repository            : $env:REPO" -ForegroundColor White
          Write-Host "ğŸ” Workflow              : $env:WORKFLOW_FILE" -ForegroundColor White
          Write-Host "ğŸ†” Deployment ID         : $env:DEPLOYMENT_ID" -ForegroundColor White
          Write-Host "â° Start Time            : $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor White
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan

      - name: ğŸ” Validate Secrets
        shell: pwsh
        run: |
          Write-Host "ğŸ” Validating secrets..." -ForegroundColor Cyan
          $errors = @()
          
          if (-not $env:SECRET_SHAHZAIB) {
            $errors += "SECRET_SHAHZAIB"
          }
          if (-not $env:NGROK_SHAHZAIB) {
            $errors += "NGROK_SHAHZAIB"
          }
          
          if ($errors.Count -gt 0) {
            Write-Host "âŒ Missing secrets: $($errors -join ', ')" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "âœ… All required secrets validated" -ForegroundColor Green

      - name: ğŸ“¥ Clone Repository
        uses: actions/checkout@v4
        with:
          repository: Karpux/instance-z
          path: instance-z

      - name: ğŸ”§ Setup Environment
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ Setting up environment..." -ForegroundColor Cyan
          
          # Crear directorio de trabajo
          $workDir = "$env:USERPROFILE\EnigMano-Ultimate"
          New-Item -Path $workDir -ItemType Directory -Force | Out-Null
          
          # Copiar scripts al directorio de trabajo
          Copy-Item -Path "instance-z\*" -Destination $workDir -Recurse -Force
          
          Write-Host "âœ… Environment setup complete" -ForegroundColor Green
          Write-Host "ğŸ“ Work directory: $workDir" -ForegroundColor White

      - name: ğŸŒ™ Configure System (Dark Mode + Optimizations)
        shell: pwsh
        run: |
          Write-Host "ğŸŒ™ Configuring system..." -ForegroundColor Cyan
          
          # Activar modo oscuro
          Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "AppsUseLightTheme" -Value 0 -Type DWord -Force
          Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "SystemUsesLightTheme" -Value 0 -Type DWord -Force
          
          # Desactivar telemetrÃ­a
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name "AllowTelemetry" -Value 0 -Type DWord -Force -ErrorAction SilentlyContinue
          
          Write-Host "âœ… System configured" -ForegroundColor Green

      - name: ğŸ“¦ Install VS Code ARM64
        if: env.MODE == 'full' || env.MODE == 'env-only'
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Installing VS Code ARM64..." -ForegroundColor Cyan
          
          $vscodeInstaller = "$env:TEMP\VSCodeSetup-arm64.exe"
          $vscodeUrl = "https://code.visualstudio.com/sha/download?build=stable&os=win32-arm64-user"
          
          # Verificar si ya estÃ¡ instalado
          $vscodePath = "$env:LOCALAPPDATA\Programs\Microsoft VS Code\Code.exe"
          if (Test-Path $vscodePath) {
            Write-Host "âœ… VS Code already installed" -ForegroundColor Green
          } else {
            Write-Host "â¬‡ï¸ Downloading VS Code ARM64..." -ForegroundColor Yellow
            Invoke-WebRequest -Uri $vscodeUrl -OutFile $vscodeInstaller -UseBasicParsing
            
            Write-Host "ğŸš€ Installing VS Code..." -ForegroundColor Yellow
            Start-Process -FilePath $vscodeInstaller -ArgumentList "/VERYSILENT /NORESTART /MERGETASKS=!runcode" -Wait
            
            Remove-Item $vscodeInstaller -Force -ErrorAction SilentlyContinue
            Write-Host "âœ… VS Code installed" -ForegroundColor Green
          }

      - name: ğŸŒ Configure Chrome
        if: env.MODE == 'full' || env.MODE == 'env-only'
        shell: pwsh
        run: |
          Write-Host "ğŸŒ Configuring Chrome..." -ForegroundColor Cyan
          
          $chromePath = "$env:ProgramFiles\Google\Chrome\Application\chrome.exe"
          
          if (Test-Path $chromePath) {
            # Inicializar Chrome
            $blankProcess = Start-Process -FilePath $chromePath -ArgumentList "about:blank" -PassThru
            Start-Sleep -Seconds 10
            Stop-Process -Id $blankProcess.Id -Force -ErrorAction SilentlyContinue
            
            Write-Host "âœ… Chrome configured" -ForegroundColor Green
          } else {
            Write-Host "âš ï¸ Chrome not found, skipping configuration" -ForegroundColor Yellow
          }

      - name: â˜ï¸ Install Google Drive
        if: env.MODE == 'full' || env.MODE == 'backup-only'
        shell: pwsh
        run: |
          Write-Host "â˜ï¸ Installing Google Drive..." -ForegroundColor Cyan
          
          $installer = "$env:TEMP\GoogleDriveSetup.exe"
          $downloadUrl = "https://dl.google.com/drive-file-stream/GoogleDriveSetup.exe"
          
          Write-Host "â¬‡ï¸ Downloading Google Drive..." -ForegroundColor Yellow
          Invoke-WebRequest -Uri $downloadUrl -OutFile $installer -UseBasicParsing
          
          Write-Host "ğŸš€ Installing Google Drive..." -ForegroundColor Yellow
          Start-Process -FilePath $installer -ArgumentList "--silent --desktop_shortcut" -Wait
          
          Remove-Item $installer -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… Google Drive installed" -ForegroundColor Green
          Write-Host "âš ï¸ Note: Manual login required for sync" -ForegroundColor Yellow

      - name: ğŸ’¾ Create Backup Structure
        if: env.MODE == 'full' || env.MODE == 'backup-only'
        shell: pwsh
        run: |
          Write-Host "ğŸ’¾ Creating backup structure..." -ForegroundColor Cyan
          
          $backupRoot = "$env:USERPROFILE\EnigMano-Backup"
          $folders = @(
            "$backupRoot\Scripts",
            "$backupRoot\Config",
            "$backupRoot\Logs",
            "$backupRoot\SystemInfo"
          )
          
          foreach ($folder in $folders) {
            New-Item -Path $folder -ItemType Directory -Force | Out-Null
          }
          
          # Guardar informaciÃ³n del sistema
          $systemInfo = @{
            InstanceID = $env:INSTANCE_ID
            DeploymentID = $env:DEPLOYMENT_ID
            Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            OS = (Get-CimInstance Win32_OperatingSystem).Caption
            Architecture = (Get-CimInstance Win32_OperatingSystem).OSArchitecture
          }
          
          $systemInfo | ConvertTo-Json | Out-File "$backupRoot\SystemInfo\deployment-info.json"
          
          Write-Host "âœ… Backup structure created" -ForegroundColor Green
          Write-Host "ğŸ“ Location: $backupRoot" -ForegroundColor White

      - name: ğŸ”¥ Execute Main Deployment
        shell: pwsh
        run: |
          Write-Host "ğŸ”¥ Executing main deployment..." -ForegroundColor Cyan
          
          $workDir = "$env:USERPROFILE\EnigMano-Ultimate"
          
          if (Test-Path "$workDir\EnigMano-Instance.ps1") {
            Write-Host "ğŸš€ Running EnigMano-Instance.ps1..." -ForegroundColor Yellow
            Set-Location $workDir
            powershell.exe -ExecutionPolicy Bypass -File ".\EnigMano-Instance.ps1"
          } else {
            Write-Host "âš ï¸ EnigMano-Instance.ps1 not found, skipping" -ForegroundColor Yellow
          }

      - name: â™¾ï¸ Start Infinite Loop (Background)
        if: env.MODE == 'full'
        shell: pwsh
        run: |
          Write-Host "â™¾ï¸ Starting infinite loop processes..." -ForegroundColor Magenta
          
          $workDir = "$env:USERPROFILE\EnigMano-Ultimate"
          
          # Iniciar Browser-Env-Setup en background
          if (Test-Path "$workDir\Browser-Env-Setup.ps1") {
            Write-Host "ğŸ”§ Starting Browser-Env-Setup (background)..." -ForegroundColor Yellow
            Start-Job -ScriptBlock {
              param($scriptPath)
              & $scriptPath
            } -ArgumentList "$workDir\Browser-Env-Setup.ps1" | Out-Null
          }
          
          # Iniciar GoogleDrive-Sync-Setup en background
          if (Test-Path "$workDir\GoogleDrive-Sync-Setup.ps1") {
            Write-Host "â˜ï¸ Starting GoogleDrive-Sync-Setup (background)..." -ForegroundColor Yellow
            Start-Job -ScriptBlock {
              param($scriptPath)
              & $scriptPath
            } -ArgumentList "$workDir\GoogleDrive-Sync-Setup.ps1" | Out-Null
          }
          
          Write-Host "âœ… Background processes started" -ForegroundColor Green
          Write-Host "ğŸ’¡ These will run indefinitely in the background" -ForegroundColor Cyan

      - name: ğŸ“Š Deployment Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘              Deployment Summary - Instance $env:INSTANCE_ID              â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          Write-Host "`nğŸ“‹ Completed Steps:" -ForegroundColor Green
          Write-Host "  âœ… System configuration (dark mode, optimizations)" -ForegroundColor White
          Write-Host "  âœ… VS Code ARM64 installation" -ForegroundColor White
          Write-Host "  âœ… Chrome configuration" -ForegroundColor White
          Write-Host "  âœ… Google Drive installation" -ForegroundColor White
          Write-Host "  âœ… Backup structure creation" -ForegroundColor White
          Write-Host "  âœ… Main deployment execution" -ForegroundColor White
          Write-Host "  âœ… Background processes started" -ForegroundColor White
          
          Write-Host "`nâ° Deployment Info:" -ForegroundColor Yellow
          Write-Host "  ğŸ• Start Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor White
          Write-Host "  ğŸ†” Instance ID: $env:INSTANCE_ID" -ForegroundColor White
          Write-Host "  ğŸ¯ Mode: $env:MODE" -ForegroundColor White
          
          Write-Host "`nğŸ’¡ Next Steps:" -ForegroundColor Cyan
          Write-Host "  1. Background processes are running indefinitely" -ForegroundColor White
          Write-Host "  2. Login to Google Drive manually for sync" -ForegroundColor White
          Write-Host "  3. Backups will occur every 5 minutes" -ForegroundColor White
          Write-Host "  4. System will continue until workflow timeout" -ForegroundColor White
          
          Write-Host "`nğŸ”‹ Powered by: SHAHZAIB-YT" -ForegroundColor Magenta
          Write-Host "ğŸ EnigMano Ultimate deployed with precision!" -ForegroundColor Green
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan

      - name: â±ï¸ Keep Alive (Until Timeout)
        shell: pwsh
        run: |
          Write-Host "â±ï¸ Keeping instance alive..." -ForegroundColor Cyan
          Write-Host "ğŸ’¡ This will run until GitHub Actions timeout" -ForegroundColor Yellow
          Write-Host "â™¾ï¸ Background processes continue indefinitely" -ForegroundColor Magenta
          
          # Mantener vivo hasta el timeout
          $startTime = Get-Date
          $cycleCount = 0
          
          while ($true) {
            $cycleCount++
            $elapsed = (Get-Date) - $startTime
            
            Write-Host "`nğŸ”„ Cycle #$cycleCount - Elapsed: $($elapsed.ToString('hh\:mm\:ss'))" -ForegroundColor Green
            Write-Host "  âœ… Instance is alive and running" -ForegroundColor White
            Write-Host "  ğŸ“Š Background jobs: $(Get-Job | Measure-Object | Select-Object -ExpandProperty Count)" -ForegroundColor White
            Write-Host "  â° Current time: $(Get-Date -Format 'HH:mm:ss')" -ForegroundColor White
            
            Start-Sleep -Seconds 60  # Check every minute
          }
