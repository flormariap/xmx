name: "âš¡ EnigMano FAST - Optimizado y RÃ¡pido"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "NÃºmero de instancia"
        required: true
        default: "1"
      AUTO_RELAY:
        description: "Auto-relay infinito"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  fast-setup:
    name: "âš¡ PC Virtual #${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-11-arm
    timeout-minutes: 360
    
    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      AUTO_RELAY: ${{ github.event.inputs.AUTO_RELAY }}
      SECRET_SHAHZAIB: ${{ secrets.SECRET_SHAHZAIB }}
      NGROK_SHAHZAIB: ${{ secrets.NGROK_SHAHZAIB }}
      GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GITLAB_REPO: ${{ secrets.GITLAB_REPO }}
    
    steps:
      - name: âš¡ Inicio RÃ¡pido
        shell: pwsh
        run: |
          Write-Host "âš¡ EnigMano FAST - Instancia #$env:INSTANCE_ID" -ForegroundColor Cyan
          Write-Host "ğŸš€ Optimizado para mÃ¡xima velocidad" -ForegroundColor Green
      
      - name: ğŸ” Validar Secrets
        shell: pwsh
        run: |
          if (-not $env:SECRET_SHAHZAIB -or -not $env:NGROK_SHAHZAIB) {
            Write-Host "âŒ Faltan secrets: SECRET_SHAHZAIB o NGROK_SHAHZAIB" -ForegroundColor Red
            exit 1
          }
          Write-Host "âœ… Secrets OK" -ForegroundColor Green
      
      - name: ğŸ“¥ Descargar Scripts desde GitLab
        shell: pwsh
        run: |
          Write-Host "ğŸ“¥ Descargando scripts desde GitLab..." -ForegroundColor Cyan
          
          if ($env:GITLAB_TOKEN -and $env:GITLAB_REPO) {
            # Clonar repo privado de GitLab
            $gitlabUrl = "https://oauth2:$env:GITLAB_TOKEN@$env:GITLAB_REPO"
            git clone $gitlabUrl gitlab-scripts
            
            # Copiar scripts necesarios
            Copy-Item "gitlab-scripts/*.ps1" . -Force -ErrorAction SilentlyContinue
            Copy-Item "gitlab-scripts/*.py" . -Force -ErrorAction SilentlyContinue
            
            Write-Host "âœ… Scripts descargados de GitLab" -ForegroundColor Green
          }
          else {
            Write-Host "âš ï¸ Sin GitLab configurado, usando scripts locales" -ForegroundColor Yellow
          }
      
      - name: âš¡ ConfiguraciÃ³n RÃ¡pida del Sistema
        shell: pwsh
        run: |
          Write-Host "âš¡ ConfiguraciÃ³n rÃ¡pida..." -ForegroundColor Cyan
          
          # Solo lo esencial
          Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "AppsUseLightTheme" -Value 0 -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "SystemUsesLightTheme" -Value 0 -Force -ErrorAction SilentlyContinue
          
          Write-Host "âœ… Sistema configurado" -ForegroundColor Green
      
      - name: ğŸ”¥ RDP + Ngrok (Ultra RÃ¡pido)
        shell: pwsh
        run: |
          Write-Host "ğŸ”¥ Configurando RDP..." -ForegroundColor Cyan
          
          # Habilitar RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          
          # Usuario
          net user runneradmin $env:SECRET_SHAHZAIB /add 2>$null
          net user runneradmin $env:SECRET_SHAHZAIB 2>$null
          net localgroup administrators runneradmin /add 2>$null
          
          # Ngrok (solo ARM64, mÃ¡s rÃ¡pido)
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-arm64.zip" -OutFile "$env:TEMP\ngrok.zip" -UseBasicParsing
          Expand-Archive -Path "$env:TEMP\ngrok.zip" -DestinationPath "$env:TEMP\ngrok" -Force
          & "$env:TEMP\ngrok\ngrok.exe" config add-authtoken $env:NGROK_SHAHZAIB
          Start-Process -FilePath "$env:TEMP\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
          
          Start-Sleep -Seconds 8
          
          # URL
          try {
            $ngrokApi = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
            $rdpUrl = $ngrokApi.tunnels[0].public_url -replace "tcp://", ""
            
            Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
            Write-Host "â•‘              âš¡ PC VIRTUAL LISTO âš¡                        â•‘" -ForegroundColor Green
            Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
            Write-Host "`nğŸ“± URL RDP: $rdpUrl" -ForegroundColor Yellow
            Write-Host "ğŸ‘¤ Usuario: runneradmin" -ForegroundColor White
            Write-Host "ğŸ”’ ContraseÃ±a: (tu SECRET_SHAHZAIB)" -ForegroundColor White
            Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Green
          } catch {
            Write-Host "âš ï¸ Ngrok iniciando..." -ForegroundColor Yellow
          }
      
      - name: ğŸ’¾ Backup Ligero
        shell: pwsh
        run: |
          Write-Host "ğŸ’¾ Backup ligero..." -ForegroundColor Cyan
          
          $backupRoot = "$env:USERPROFILE\Backup"
          New-Item -Path $backupRoot -ItemType Directory -Force | Out-Null
          
          # Crear script de backup directamente
          $scriptContent = 'while ($true) { Copy-Item "$env:USERPROFILE\Desktop\*" -Destination "$env:USERPROFILE\Backup\" -Recurse -Force -ErrorAction SilentlyContinue; Start-Sleep -Seconds 600 }'
          $scriptContent | Out-File "$env:TEMP\backup.ps1" -Force
          
          # Iniciar en background
          Start-Job -ScriptBlock { 
            param($script)
            & powershell -ExecutionPolicy Bypass -Command $script
          } -ArgumentList $scriptContent | Out-Null
          
          Write-Host "âœ… Backup activo (cada 10 min)" -ForegroundColor Green
      
      - name: â±ï¸ Mantener Vivo (Optimizado)
        shell: pwsh
        run: |
          Write-Host "â±ï¸ PC Virtual activo..." -ForegroundColor Cyan
          
          $startTime = Get-Date
          $targetMinutes = 355
          
          while ($true) {
            $elapsed = (Get-Date) - $startTime
            $elapsedMinutes = $elapsed.TotalMinutes
            
            # Mostrar cada 5 minutos
            if ([math]::Floor($elapsedMinutes) % 5 -eq 0) {
              $remaining = $targetMinutes - $elapsedMinutes
              Write-Host "â° $([math]::Floor($elapsedMinutes)) min | â³ $([math]::Floor($remaining)) min restantes | âœ… ACTIVO" -ForegroundColor Green
            }
            
            if ($elapsedMinutes -ge $targetMinutes) {
              Write-Host "ğŸ”„ Preparando relay..." -ForegroundColor Yellow
              break
            }
            
            Start-Sleep -Seconds 60
          }
      
      - name: ğŸ“¤ Subir Backup
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ github.event.inputs.INSTANCE }}
          path: ${{ runner.temp }}\Backup\**
          retention-days: 7
        continue-on-error: true
      
      - name: ğŸ“¤ Sincronizar con GitLab
        if: always() && env.GITLAB_TOKEN != ''
        shell: pwsh
        run: |
          Write-Host "ğŸ“¤ Sincronizando con GitLab..." -ForegroundColor Cyan
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          if ($env:GITLAB_REPO -and $env:GITLAB_TOKEN) {
            $gitlabUrl = "https://oauth2:$env:GITLAB_TOKEN@$env:GITLAB_REPO"
            
            try {
              git remote add gitlab $gitlabUrl 2>$null
              git push gitlab --all --force 2>$null
              Write-Host "âœ… Sincronizado con GitLab" -ForegroundColor Green
            } catch {
              Write-Host "âš ï¸ Sync opcional omitido" -ForegroundColor Yellow
            }
          }
      
      - name: ğŸ”„ Auto-Relay
        if: always() && github.event.inputs.AUTO_RELAY == 'true'
        shell: pwsh
        run: |
          $nextInstance = [int]$env:INSTANCE_ID + 1
          
          Write-Host "ğŸ”„ Ejecutando instancia #$nextInstance..." -ForegroundColor Cyan
          
          try {
            gh workflow run enigmano-fast.yml -f INSTANCE=$nextInstance -f AUTO_RELAY=true
            Write-Host "âœ… Siguiente instancia iniciada" -ForegroundColor Green
          } catch {
            Write-Host "âš ï¸ Ejecuta manualmente si es necesario" -ForegroundColor Yellow
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“Š Resumen
        if: always()
        shell: pwsh
        run: |
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘              âš¡ RESUMEN RÃPIDO âš¡                          â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          Write-Host "`nâœ… COMPLETADO:" -ForegroundColor Green
          Write-Host "   â€¢ RDP configurado" -ForegroundColor White
          Write-Host "   â€¢ Ngrok activo" -ForegroundColor White
          Write-Host "   â€¢ Backup automÃ¡tico" -ForegroundColor White
          if ($env:GITLAB_TOKEN) {
            Write-Host "   â€¢ GitLab sincronizado" -ForegroundColor White
          }
          
          Write-Host "`nâš¡ Optimizado para velocidad - Sin instalaciones innecesarias" -ForegroundColor Green
          Write-Host "ğŸ“± ConÃ©ctate por RDP desde tu telÃ©fono" -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan
